<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/blogs/images/logo/favicon.ico"><title>聊一聊Vue2中的Diff算法 | OUDUIDUI</title><meta name="description" content="聊一聊Vue2中的Diff算法">
    <link rel="modulepreload" href="/blogs/assets/app.39fe5b0d.js"><link rel="modulepreload" href="/blogs/assets/vue-diff.html.3fadcfc6.js"><link rel="modulepreload" href="/blogs/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/blogs/assets/vue-diff.html.96cb1f61.js">
    <link rel="stylesheet" href="/blogs/assets/style.df42475a.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blogs/" class=""><!----><span class="site-name can-hide">OUDUIDUI</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blogs/front-end/vue/vue2-and-vue3-component-communication.md" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/OUDUIDUI/blogs" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blogs/front-end/vue/vue2-and-vue3-component-communication.md" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/OUDUIDUI/blogs" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-heading sidebar-item active" aria-label="聊一聊Vue2中的Diff算法"><!--[--><!--]--> 聊一聊Vue2中的Diff算法 <!--[--><!--]--></a><ul class=""><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#vue2是如何更新节点" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Vue2是如何更新节点"><!--[--><!--]--> Vue2是如何更新节点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#什么是虚拟dom" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="什么是虚拟DOM"><!--[--><!--]--> 什么是虚拟DOM <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#diff的实现" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Diff的实现"><!--[--><!--]--> Diff的实现 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#流程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="流程"><!--[--><!--]--> 流程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#准备工作" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="准备工作"><!--[--><!--]--> 准备工作 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#patch" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="patch"><!--[--><!--]--> patch <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#patchvnode" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="patchVnode"><!--[--><!--]--> patchVnode <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#updatechildren" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="updateChildren"><!--[--><!--]--> updateChildren <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#流程图" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="流程图"><!--[--><!--]--> 流程图 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/front-end/vue/vue-diff.html#为什么要用key值" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="为什么要用key值"><!--[--><!--]--> 为什么要用key值 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--[--><a href="/blogs/front-end/vue/vue2-and-vue3-component-communication.html" class="nav-link sidebar-heading sidebar-item" aria-label="Vue2和Vue3的组件通信"><!--[--><!--]--> Vue2和Vue3的组件通信 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/blogs/front-end/vue/vue-components-communication.html" class="nav-link sidebar-heading sidebar-item" aria-label="关于Vue2组件通讯那点事"><!--[--><!--]--> 关于Vue2组件通讯那点事 <!--[--><!--]--></a><!----><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="聊一聊vue中的diff算法" tabindex="-1"><a class="header-anchor" href="#聊一聊vue中的diff算法" aria-hidden="true">#</a> 聊一聊Vue中的Diff算法</h1><h2 id="vue2是如何更新节点" tabindex="-1"><a class="header-anchor" href="#vue2是如何更新节点" aria-hidden="true">#</a> Vue2是如何更新节点</h2><p>我们都知道，<code>Vue</code>中是使用了基于<code>HTML</code>的模板语法，允许开发者声明式地将<code>DOM</code>绑定至底层<code>Vue</code>实例的数据。而初始化的时候，<code>Vue</code>就会将该模板语法转化为真实<code>DOM</code>，渲染到页面中。</p><div class="language-html ext-html line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">&lt;template&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">	</span><span style="color:#81A1C1;">&lt;div&gt;</span><span style="color:#D8DEE9FF;">{{msg}}</span><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/template&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">&lt;script&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#D8DEE9;">export</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">default</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">data</span><span style="color:#D8DEE9FF;">() </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">msg</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">HelloWorld</span><span style="color:#ECEFF4;">&#39;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/script&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>但当数据发生变化的时候，<code>Vue</code>会如何去更新页面呢？</p><p>如果选择重新渲染整个<code>DOM</code>，那必然会引起整个<code>DOM</code>树的重绘和重排，而在真实项目中，不可能就跟上面的例子一样只有一句<code>&lt;div&gt;&lt;/div&gt;</code>。当我们的页面非常复杂的情况下，且修改的数据只影响到一小部分页面数据的更新的时候，重新渲染页面一定是不可取的。</p><p>而这时候，最便捷的方式，就是找到该修改的数据所影响到的<code>DOM</code>，然后只更新那一个<code>DOM</code>就可以了。这就是<code>Vue</code>更新页面的方法。</p><p><code>Vue</code>在初始化页面后，会将当前的真实<code>DOM</code>转换为虚拟<code>DOM</code>（Virtual DOM），并将其保存起来，这里称为<code>oldVnode</code>。然后当某个数据发变化后，<code>Vue</code>会先生成一个新的虚拟<code>DOM</code>——<code>vnode</code>，然后将<code>vnode</code>和<code>oldVnode</code>进行比较，找出需要更新的地方，然后直接在对应的真实<code>DOM</code>上进行修改。当修改结束后，就将<code>vnode</code>赋值给<code>oldVnode</code>存起来，作为下次更新比较的参照物。</p><p>而这个更新中的难点，也是我们今天要聊的内容，就是新旧<code>vnode</code>的比较，也就是我们常说的<code>Diff</code>算法。</p><h2 id="什么是虚拟dom" tabindex="-1"><a class="header-anchor" href="#什么是虚拟dom" aria-hidden="true">#</a> 什么是虚拟DOM</h2><p>前面我们提到了虚拟<code>DOM</code>（Virtual DOM），那虚拟<code>DOM</code>是什么呢？</p><p>我们可能曾经打印过真实<code>DOM</code>，它实质上是个对象，但是它的元素是非常的多的，即使是很简单的几句代码。</p><p><img src="/blogs/images/docs/vue-diff/dom.png" alt="dom"></p><p>因此，在真实<code>DOM</code>下，我们不太敢随便去直接操作和改动。</p><p>这时候，虚拟<code>DOM</code>就诞生了。它也是一个对象，而它其实是将真实<code>DOM</code>的数据抽取出来，以对象的形式模拟树形结构，使其更加简洁明了。</p><p>虚拟<code>DOM</code>没有很固定的模板，每个框架上的实现都存在差异，但是大部分结构都是相同的。下面我们就用<code>Vue</code>的虚拟<code>DOM</code>举个例子。</p><div class="language-html ext-html line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">&lt;div</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">id</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">app</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">&lt;p</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">class</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">HelloWorld</span><span style="color:#81A1C1;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面的<code>DOM</code>通过<code>Vue</code>生成了下面的虚拟<code>DOM</code>（有删减），对象中包含了根节点的标签<code>tag</code>、<code>key</code>值，文本信息<code>text</code>等等，同时也含有<code>elm</code>属性存放真实<code>DOM</code>，同时有个<code>children</code>数组，存放着子节点，子节点的结构也是一致的。</p><div class="language-json ext-json line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">tag</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">div</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">  </span><span style="color:#616E88;">// 标签</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">undefined</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">  </span><span style="color:#616E88;">// key值</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">elm</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">div#app</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">   </span><span style="color:#616E88;">// 真实DOM</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">undefined</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">   </span><span style="color:#616E88;">// 文本信息</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">attrs</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">id</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">app</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}},</span><span style="color:#D8DEE9FF;"> </span><span style="color:#616E88;">// 节点属性</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">children</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">[{</span><span style="color:#D8DEE9FF;">    </span><span style="color:#616E88;">// 孩子属性</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">tag</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">p</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">undefined</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">elm</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">p.text</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">undefined</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">attrs</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}},</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">children</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">[{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">tag</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">undefined</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">undefined</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">elm</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">text</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">helloWorld</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">undefined</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">children</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">[]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>当我们把一些常用的信息提取出来，并且使用对象嵌套的形式，去存放子节点信息，从而形成一个虚拟<code>DOM</code>,这时候我们用其来进行比较的话，就会比两个真实<code>DOM</code>做比较简单多了。</p><p>在<code>Vue</code>中，有个<code>render</code>函数，这个函数返回的<code>VNode</code>就是一个虚拟<code>DOM</code>。当然，你也可以使用 <a href="https://github.com/Matt-Esch/virtual-dom" target="_blank" rel="noopener noreferrer">virtual-dom<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 或 <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">snabbdom<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 去体验一下虚拟<code>DOM</code>。</p><h2 id="diff的实现" tabindex="-1"><a class="header-anchor" href="#diff的实现" aria-hidden="true">#</a> Diff的实现</h2><p>在使用<code>Diff</code>算法比较两个节点的时候，只会在同层级进行比较，而不会跨层级比较。</p><p><img src="/blogs/images/docs/vue-diff/diff.gif" alt="diff"></p><h3 id="流程" tabindex="-1"><a class="header-anchor" href="#流程" aria-hidden="true">#</a> 流程</h3><p>在<code>Vue</code>中，主要是<code>patch()</code>、<code>patchVnode()</code>和<code>updateChildren()</code>这三个主要方法来实现<code>Diff</code>的。</p><ul><li>当我们<code>Vue</code>中的响应式数据变化的时候，就会触发页面更新函数<code>updateComponent()</code>（如何触发可以通过阅读<code>Vue</code>源码进行学习或者看一下我之前一篇<a href="https://juejin.cn/post/6963079075938172936" target="_blank" rel="noopener noreferrer">《简单手写实现Vue2.x》<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>）；</li><li>此时<code>updateComponet()</code>就会调用<code>patch()</code>方法，在该方法中进行比较是否为相同节点，是的话执行<code>patchVnode()</code>方法，开始比较节点差异；而如果不是相同节点的话，则进行替换操作，具体后面会讲到；</li><li>在<code>patchVnode()</code>中，首先是更新节点属性，然后会判断有没有孩子节点，有的话则执行<code>updateChildren()</code>方法，对孩子节点进行比较；如果没有孩子节点的话，则进行节点文本内容判断更新；（文本节点是不会有孩子节点的）</li><li><code>updateChildren()</code>中，会对传入的两个孩子节点数组进行一一比较，当找到相同节点的情况下，调用<code>patchVnode()</code>继续节点差异比较。</li></ul><p><img src="/blogs/images/docs/vue-diff/diff.jpg" alt="diff"></p><h3 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作" aria-hidden="true">#</a> 准备工作</h3><p>为了后面更好的看核心代码，我们先在前面捋清楚一些函数。</p><h4 id="isdef-和-isundef" tabindex="-1"><a class="header-anchor" href="#isdef-和-isundef" aria-hidden="true">#</a> isDef 和 isUndef</h4><p>在源码中会用<code>isDef()</code>和<code>isUndef()</code>判断<code>vnode</code>是否存在，实质上是判断<code>vnode</code>是不是<code>undefined</code>或<code>null</code>，毕竟<code>vnode</code>虚拟DOM是个对象。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">export</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">v</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">any</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">boolean</span><span style="color:#D8DEE9FF;"> %checks </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">v</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">undefined</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">||</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">v</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">export</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">v</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">any</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">boolean</span><span style="color:#D8DEE9FF;"> %checks </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">v</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">!==</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">undefined</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">v</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">!==</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="samevnode" tabindex="-1"><a class="header-anchor" href="#samevnode" aria-hidden="true">#</a> sameVnode</h4><p>在源码中会用<code>sameVnode()</code>方法去判断两个节点是否相同，实质上是通过去判断<code>key</code>值，<code>tag</code>标签等静态属性从而去判断两个节点是否为相同节点。</p><p>注意的是，这里的相同节点不意味着为相等节点，比如<code>&lt;div&gt;HelloWorld&lt;/div&gt;</code>和<code>&lt;div&gt;HiWorld&lt;/div&gt;</code>为相同节点，但是它们并不相等。在源码中是通过<code>vnode1 === vnode2</code>去判断是不是为相等节点。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#616E88;">// 比较是否相同节点</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">sameVnode</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">asyncFactory</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">asyncFactory</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      (</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">tag</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">tag</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">isComment</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">isComment</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">sameInputType</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      ) </span><span style="color:#81A1C1;">||</span><span style="color:#D8DEE9FF;"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">isTrue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">isAsyncPlaceholder</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">asyncFactory</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      )</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  )</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">sameInputType</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">tag</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">!==</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">input</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">true</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">typeA</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">attrs</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">type</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">typeB</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">attrs</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">type</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">typeA</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">typeB</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">||</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isTextInputType</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">typeA</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isTextInputType</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">typeB</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="patch" tabindex="-1"><a class="header-anchor" href="#patch" aria-hidden="true">#</a> patch</h3><p>接下来开始看源码了，看看<code>Vue</code>是如何实现<code>Diff</code>算法。</p><blockquote><p>下面的所有代码都只保留核心的代码，想看全部代码可以去看<code>Vue</code>的源码（patch文件路径：https://github.com/vuejs/vue/blob/2.6/src/core/vdom/patch.js ）。</p></blockquote><p>首先看看<code>patch()</code>方法，该方法接收新旧虚拟Dom，即<code>oldVnode</code>，<code>vnode</code>，这个函数其实是对新旧虚拟<code>Dom</code>做一个简单的判断，而还没有进入详细的比较阶段。</p><ul><li>首先判断<code>vnode</code>是否存在，如果不存在的话，则代表这个旧节点要整个删除；</li><li>如果<code>vnode</code>存在的话，再判断<code>oldVnode</code>是否存在，如果不存在的话，则代表只需要新增整个<code>vnode</code>节点就可以；</li><li>如果<code>vnode</code>和<code>oldVnode</code>都存在的话，判断两者是不是相同节点，如果是的话，这调用<code>patchVnode</code>方法，对两个节点进行详细比较判断；</li><li>如果两者不是相同节点的话，这种情况一般就是初始化页面，此时<code>oldVnode</code>其实是真实<code>Dom</code>，这是只需要将<code>vnode</code>转换为真实<code>Dom</code>然后替换掉<code>oldVnode</code>，具体就不多讲，这不是今天讨论的范围内。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#616E88;">// 更新时调用的__patch__</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">patch</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">hydrating</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">removeOnly</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// 判断新节点是否存在</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#88C0D0;">invokeDestroyHook</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#D8DEE9FF;">)  </span><span style="color:#616E88;">// 新的节点不存在且旧节点存在：删除</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">return</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">	</span><span style="color:#616E88;">// 判断旧节点是否存在</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 旧节点不存在且新节点存在：新增</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">createElm</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#D8DEE9FF;">)  </span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 比较新旧节点 diff算法</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">removeOnly</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 初始化页面（此时的oldVnode是个真实DOM）</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">emptyNodeAt</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 创建新的节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">createElm</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldElm</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">_leaveCb</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">?</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nextSibling</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldElm</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><img src="/blogs/images/docs/vue-diff/diff2.jpg" alt="diff2"></p><h3 id="patchvnode" tabindex="-1"><a class="header-anchor" href="#patchvnode" aria-hidden="true">#</a> patchVnode</h3><p>在<code>patchVnode()</code>中，同样是接收新旧虚拟Dom，即<code>oldVnode</code>，<code>vnode</code>；在该函数中，即开始对两个虚拟<code>Dom</code>进行比较更新了。</p><ul><li>首先判断两个虚拟<code>Dom</code>是不是全等，即没有任何变动；是的话直接结束函数，否则继续执行；</li><li>其次更新节点的属性；</li><li>接着判断<code>vnode.text</code>是否存在，即<code>vnode</code>是不是文本节点。是的话，只需要更新节点文本既可，否则的话，这继续比较；</li><li>判断<code>vnode</code>和<code>oldVnode</code>是否有孩子节点： <ul><li>如果两者都有孩子节点的话，执行<code>updateChildren()</code>方法，进行比较更新孩子节点；</li><li>如果<code>vnode</code>有孩子节点而<code>oldVnode</code>没有的话，则直接新增所有孩子节点，并将该节点文本属性设为空；</li><li>如果<code>oldVnode</code>有孩子节点而<code>vnode</code>没有的话，则直接删除所有孩子节点；</li><li>如果两者都没有孩子节点，就判断<code>oldVnode.text</code>是否有内容，有的话清空内容既可。</li></ul></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#616E88;">// 比较两个虚拟DOM</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">  </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ownerArray</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">index</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">removeOnly</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// 如果两个虚拟DOM一样，无需比较直接返回</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">===</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">return</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// 获取真实DOM</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// 获取两个比较节点的孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">children</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ch</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">children</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// 属性更新</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isPatchable</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">for</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">cbs</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">update</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">) </span><span style="color:#D8DEE9;">cbs</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">update</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">](</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">hook</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">update</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#88C0D0;">i</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">   </span><span style="color:#616E88;">// 没有文本 -&gt; 该情况一般都是有孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">ch</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">  </span><span style="color:#616E88;">// 新旧节点都有孩子节点 -&gt; 比较子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">!==</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ch</span><span style="color:#D8DEE9FF;">) </span><span style="color:#88C0D0;">updateChildren</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ch</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">removeOnly</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">ch</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">  </span><span style="color:#616E88;">// 新节点有孩子节点，旧节点没有孩子节点 -&gt; 新增</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setTextContent</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;&#39;</span><span style="color:#D8DEE9FF;">)  </span><span style="color:#616E88;">// 如果旧节点有文本内容，将其设置为空</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">addVnodes</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ch</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ch</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">   </span><span style="color:#616E88;">// 旧节点有孩子节点，新节点没有孩子节点 -&gt; 删除</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">removeVnodes</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">   </span><span style="color:#616E88;">// 旧节点有文本，新节点没有文本 -&gt; 删除文本</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setTextContent</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;&#39;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">!==</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">  </span><span style="color:#616E88;">// 新旧节点文本不同 -&gt; 更新文本</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setTextContent</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><img src="/blogs/images/docs/vue-diff/diff3.jpg" alt="diff3"></p><h3 id="updatechildren" tabindex="-1"><a class="header-anchor" href="#updatechildren" aria-hidden="true">#</a> updateChildren</h3><p>最后就来看看<code>updateChildren</code>方法了，这个也是最难理解的一部分，所以就先带大家一步步捋清楚后，手写一下，再看源码。</p><p>首先这个方法传入三个比较重要的参数，即<code>parentElm</code>父级真实节点，便于直接节点操作；<code>oldCh</code>为<code>oldVnode</code>的孩子节点；<code>newCh</code>为<code>Vnode</code>的孩子节点。</p><p><code>oldCh</code>和<code>newCh</code>都是一个数组。 这个方法的作用，就是对这两个数组一一比较，找到相同的节点，执行<code>patchVnode</code>再次进行比较更新，剩下的少退多补。</p><p>这个方法我们想到最简单的方法，就是两个数组进行遍历匹配，但是这样子的复杂度是很大的，时间复杂度为<code>O(NM)</code>，而且我们真实项目中，页面结构是非常庞大和复杂的，所以这个方案是非常耗性能的。</p><p>在<code>Vue</code>中，主要的实现是用四个指针进行实现。四个指针初始位置分别在两个数组的头尾。因此我们先来初始化必要的变量。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">   								</span><span style="color:#616E88;">// oldCh数组左边的指针位置</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">  			  </span><span style="color:#616E88;">// oldCh数组左边的指针对应的节点</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> 		</span><span style="color:#616E88;">// oldCh数组右边的指针位置</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> 	</span><span style="color:#616E88;">// oldCh数组右边的指针对应的节点</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">									</span><span style="color:#616E88;">// newCh数组左边的指针位置</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">					</span><span style="color:#616E88;">// newCh数组左边的指针对应的节点</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">			</span><span style="color:#616E88;">// newCh数组右边的指针位置</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> 	</span><span style="color:#616E88;">// newCh数组右边的指针对应的节点</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="/blogs/images/docs/vue-diff/diff4.jpeg" alt="diff4"></p><p>然而这四个指针不会一直不动的，它们会进行相互比较，如果比较得出是相同节点后，对应两个指针就会向另一侧移动，而直至两两重合的时候，这个循环也就结束了。</p><p>当然看到这里，你会有很多疑问，但先把疑问记起来，后面都会一一作答的。我们接着写一个循环语句。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// TODO</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接着我们开始相互比较。</p><p>首先是<code>oldStartVnode</code>和<code>newStartVnode</code>进行比较，如果比较相同的话，我们就可以执行<code>patchVnode</code>语句，并且移动<code>oldStartIdx</code>和<code>newStartIdx</code>。</p><p><img src="/blogs/images/docs/vue-diff/diff2.gif" alt="diff2"></p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果<code>oldStartVnode</code>和<code>newStartVnode</code>匹配不上的话，接下来就是<code>oldEndVnode</code>和<code>newEndVnode</code>做比较了。</p><p><img src="/blogs/images/docs/vue-diff/diff3.gif" alt="diff3"></p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>但如果两头比较和两尾比较都不是相同节点的话，这时候就开始交叉比较了。首先是<code>oldStartVnode</code>和<code>newEndVnode</code>做比较。</p><p><img src="/blogs/images/docs/vue-diff/diff4.gif" alt="diff4"></p><p>但交叉比较的时候如果匹配上的话，就需要注意到一个问题，这时候你不仅仅要比较更新节点的内容，你还需要移动节点的位置，因此我们可以借助<code>insertBefore</code>和<code>nextSibling</code>的<code>DOM</code>操作方法去实现，这个自行去学习叭。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 将oldStartVnode节点移动到对应位置，即oldEndVnode节点的后面</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">insertBefore</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nextSibling</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>如果<code>oldStartVnode</code>和<code>newEndVnode</code>匹配不上的话，就<code>oldEndVnode</code>和<code>newStartVnode</code>进行比较。</p><p><img src="/blogs/images/docs/vue-diff/diff5.gif" alt="diff5"></p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 将oldEndVnode节点移动到对应位置，即oldStartVnode节点的前面</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">insertBefore</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>此时，如果四种比较方法都匹配不到相同节点的话，我们就只能使用暴力解法去实现了，也就是针对于<code>newStartVnode</code>这个节点，我们去遍历<code>oldCh</code>中剩余的节点，一一匹配。</p><p>在<code>Vue</code>中，我们知道标签会有一个属性——<code>key</code>值，而在同一级的<code>Dom</code>中，如果<code>key</code>有值的话，它必须是唯一的；如果不设值就默认为<code>undefined</code>。所以我们可以先用<code>key</code>来配对一下。</p><p>我们可以先生成一个<code>oldCh</code>的<code>key-&gt;index</code>的映射表，我们可以创建一个函数<code>createKeyToOldIdx</code>实现，返回的结果用一个变量<code>oldKeyToIdx</code>去存储。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">createKeyToOldIdx</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">children</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">beginIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">endIdx</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">key</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">map</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">for</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">beginIdx</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">endIdx</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">children</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">]</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#D8DEE9;">map</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">] </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">map</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这时候，如果<code>newStartVnode</code>存在<code>key</code>的话，我们就可以直接用<code>oldKeyToIdx[newStartVnode.key]</code>拿到对应旧孩子节点的下标<code>index</code>。</p><p>但如果<code>newStartVnode</code>没有<code>key</code>值的话，就只能通过遍历<code>oldCh</code>中剩余的节点，一一进行匹配获取对应下标<code>index</code>，这个也可以封装成一个函数去实现。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">findIdxInOld</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">node</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">start</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">end</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">for</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">start</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">end</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">c</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">c</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">node</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">c</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这时候我们先继续手写代码。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 遍历剩余的旧孩子节点，将有key值的生成index表 &lt;{key: i}&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">createKeyToOldIdx</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 如果newStartVnode存在key，就进行匹配index值；如果没有key值，遍历剩余的旧孩子节点，一一与newStartVnode匹配，相同节点的返回index</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">?</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">findIdxInOld</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>当然，这个情况下，<code>idxInOld</code>下标值还是有可能为空，这种情况就代表那个<code>newStartVnode</code>是一个全新的节点，这时候我们只需要新增节点就可以了。</p><p>如果<code>idxInOld</code>不为空的话，我们就获取对应的<code>oldVnode</code>，然后与<code>newStartVnode</code>进行比较，如果是相同节点的话，调用<code>patchVnode()</code>函数， 并且将对应的<code>oldVnode</code>设置为<code>undefined</code>；如果匹配出来时不同节点，那就直接创建一个节点既可。</p><p>最后，移动一下<code>newStartIdx</code>。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 遍历剩余的旧孩子节点，将有key值的生成index表 &lt;{key: i}&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">createKeyToOldIdx</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 如果newStartVnode存在key，就进行匹配index值；如果没有key值，遍历剩余的旧孩子节点，一一与newStartVnode匹配，相同节点的返回index</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">?</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">findIdxInOld</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 如果匹配不到index，则创建新节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">createElm</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">false</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 获取对应的旧孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">        </span><span style="color:#616E88;">// 因为idxInOld是处于oldStartIdx和oldEndIdx之间，因此只能将其设置为undefined，而不是移动两个指针</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;">] </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">undefined</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">insertBefore</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">        </span><span style="color:#616E88;">// 如果key相同但节点不同，就创建一个新的节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">createElm</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">false</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 移动新节点的左边指针</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p><img src="/blogs/images/docs/vue-diff/diff6.gif" alt="diff6"></p><p>这里有个重点，如果我们匹配到对应的<code>oldVnode</code>的话，需要将其设置为<code>undefined</code>，同时当后面我们的<code>oldStartIdx</code>和<code>oldEndIdx</code>移动后，如果判断出对应的<code>vnode</code>为<code>undefined</code>时，就需要选择跳过。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 当oldStartVnode为undefined的时候，oldStartVnode右移</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 当oldEndVnode为undefined的时候，oldEndVnode左移</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><img src="/blogs/images/docs/vue-diff/diff7.gif" alt="diff7"></p><p><img src="/blogs/images/docs/vue-diff/diff8.gif" alt="diff8"></p><p>到这个时候，我们已经完成的差不多了，只剩下最后的收尾工作了。</p><p>如果这时候，<code>oldCh</code>的两个指针已经重叠并越过，而<code>newCh</code>的两个指针还未重叠；或者说是相反情况下。</p><p><img src="/blogs/images/docs/vue-diff/diff5.jpeg" alt="diff5"></p><p>这时候，如果<code>oldCh</code>有多余的<code>vnode</code>，我们只需要将其都删除既可；如果是<code>newCh</code>有多余的<code>vnode</code>，我们只需新增它们就可以了。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">refElm</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 当旧节点左指针已经超过右指针的时候，新增剩余的新的孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">refElm</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]) </span><span style="color:#81A1C1;">?</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">addVnodes</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">refElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 当新节点左指针已经超过右指针的时候，删除剩余的旧的孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">removeVnodes</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>这时候，我们就完成了<code>updateChildren()</code>方法了，整体代码如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#616E88;">// 比较两组孩子节点</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">updateChildren</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">removeOnly</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// 设置首尾4个指针和对应节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// diff查找是所需的变量</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">refElm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">  </span><span style="color:#616E88;">// 循环结束条件：新旧节点的头尾指针都重合</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 当oldStartVnode为undefined的时候，oldStartVnode右移</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 当oldEndVnode为undefined的时候，oldEndVnode左移</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 当oldStartVnode与newStartVnode节点相同，对比节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 对应两个指针更新</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 当oldEndVnode与newEndVnode节点相同，对比节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 对应两个指针更新</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 当oldStartVnode与newEndVnode节点相同，对比节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 将oldStartVnode节点移动到对应位置，即oldEndVnode节点的后面</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">insertBefore</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nextSibling</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;">))</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 对应两个指针更新</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">newEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 当oldEndVnode与newStartVnode节点相同，对比节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 将oldEndVnode节点移动到对应位置，即oldStartVnode节点的前面</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">insertBefore</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 对应两个指针更新</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">oldEndVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">--</span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">   </span><span style="color:#616E88;">// 暴力解法 使用key匹配</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 遍历剩余的旧孩子节点，将有key值的生成index表 &lt;{key: i}&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">createKeyToOldIdx</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 如果newStartVnode存在key，就进行匹配index值；如果没有key值，遍历剩余的旧孩子节点，一一与newStartVnode匹配，相同节点的返回index</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isDef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#81A1C1;">?</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldKeyToIdx</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">findIdxInOld</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">        </span><span style="color:#616E88;">// 如果匹配不到index，则创建新节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#88C0D0;">createElm</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">false</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">        </span><span style="color:#616E88;">// 获取对应的旧孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#88C0D0;">sameVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">          </span><span style="color:#88C0D0;">patchVnode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">          </span><span style="color:#616E88;">// 因为idxInOld是处于oldStartIdx和oldEndIdx之间，因此只能将其设置为undefined，而不是移动两个指针</span></span>
<span class="line"><span style="color:#D8DEE9FF;">          </span><span style="color:#D8DEE9;">oldCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">idxInOld</span><span style="color:#D8DEE9FF;">] </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">undefined</span></span>
<span class="line"><span style="color:#D8DEE9FF;">          </span><span style="color:#D8DEE9;">nodeOps</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">insertBefore</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">vnodeToMove</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">          </span><span style="color:#616E88;">// 如果key相同但节点不同，就创建一个新的节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">          </span><span style="color:#88C0D0;">createElm</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartVnode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">false</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">      </span><span style="color:#616E88;">// 移动新节点的左边指针</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span><span style="color:#D8DEE9;">newStartVnode</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 当旧节点左指针已经超过右指针的时候，新增剩余的新的孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">refElm</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">isUndef</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]) </span><span style="color:#81A1C1;">?</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">null</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elm</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">addVnodes</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">parentElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">refElm</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">insertedVnodeQueue</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">else</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">newStartIdx</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">newEndIdx</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 当新节点左指针已经超过右指针的时候，删除剩余的旧的孩子节点</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">removeVnodes</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">oldCh</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldStartIdx</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">oldEndIdx</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h3 id="流程图" tabindex="-1"><a class="header-anchor" href="#流程图" aria-hidden="true">#</a> 流程图</h3><p><img src="/blogs/images/docs/vue-diff/diff6.png" alt="diff6"></p><h3 id="为什么要用key值" tabindex="-1"><a class="header-anchor" href="#为什么要用key值" aria-hidden="true">#</a> 为什么要用key值</h3><p>我们在前面的<code>sameVnode()</code>可以看到，我们在比较两个节点是否相同的时候，第一个判断条件就是<code>vnode.key</code>；并且在后面使用暴力解法的时候，第一选择也是通过<code>key</code>去匹配，而这样会有什么好处呢？我们通过下面一个简单的例子来解答这个问题叭。</p><p>假设我们此时的新旧节点如下：</p><div class="language-html ext-html line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#616E88;">&lt;!--  old  --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">&lt;p&gt;</span><span style="color:#D8DEE9FF;">A</span><span style="color:#81A1C1;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">&lt;p&gt;</span><span style="color:#D8DEE9FF;">B</span><span style="color:#81A1C1;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">&lt;p&gt;</span><span style="color:#D8DEE9FF;">C</span><span style="color:#81A1C1;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">&lt;!--  new  --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">&lt;p&gt;</span><span style="color:#D8DEE9FF;">B</span><span style="color:#81A1C1;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">&lt;p&gt;</span><span style="color:#D8DEE9FF;">C</span><span style="color:#81A1C1;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  </span><span style="color:#81A1C1;">&lt;p&gt;</span><span style="color:#D8DEE9FF;">A</span><span style="color:#81A1C1;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在上面的例子，我们可以看出，<code>&lt;p&gt;A&lt;/p&gt;</code>被移动到最后面去了。</p><p>但如果我们没有设置<code>key</code>值的话，通过<code>diff</code>需要操作<code>Dom</code>的次数会很多，因为当<code>key</code>为<code>undefined</code>的情况下，每个<code>p</code>标签其实都是相同节点，因此这是执行<code>diff</code>的话，它会将第一个<code>A</code>改成<code>B</code>，把第二个<code>B</code>改成<code>C</code>，把第三个<code>C</code>改成<code>A</code>，这时一共操作了三次<code>Dom</code>。</p><p><img src="/blogs/images/docs/vue-diff/diff9.gif" alt="diff9"></p><p>但如果，我们分别给对应添加了<code>key</code>值，通过<code>diff</code>只需操作一次<code>Dom</code>，即将第一个节点移动到最后既可。</p><p><img src="/blogs/images/docs/vue-diff/diff10.gif" alt="diff10"></p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/OUDUIDUI/blogs/edit/master/front-end/vue/vue-diff.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><span class="meta-item-info">2021/12/24 下午5:15:25</span></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: oushihao97@163.com">oushihao</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><!----><span class="next"><a href="/blogs/front-end/vue/vue2-and-vue3-component-communication.html" class="nav-link" aria-label="Vue2和Vue3的组件通信"><!--[--><!--]--> Vue2和Vue3的组件通信 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/blogs/assets/app.39fe5b0d.js" defer></script>
  </body>
</html>
